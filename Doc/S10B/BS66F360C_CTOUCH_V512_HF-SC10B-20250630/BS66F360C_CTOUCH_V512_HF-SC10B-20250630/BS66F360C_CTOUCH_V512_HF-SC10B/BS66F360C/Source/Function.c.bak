
#include "Function.h"

void	Fun_IrRecKeyProcess(void)
{
	/*if(gubv_IrRecUpdata == 1)
	{
		gubv_IrRecUpdata = 0;
		if(!gu8v_IrDelay)
		{
			if((gu8v_IrRecData[0]==C_IR_USERID_LOW)&&(gu8v_IrRecData[1]==C_IR_USERID_HIGHT)) //
			{	
				if(!(gu8v_IrRecData[2] & gu8v_IrRecData[3]))
				{
					switch(gu8v_IrRecData[2])
					{
						case C_IR_KEY_DEC:
							gubv_KeyShortPreDec = 1;
						break;
						case C_IR_KEY_INC:
							gubv_KeyShortPreAdd = 1;
						break;
						case C_IR_KEY_AUTO:
							gubv_KeyShortAuto = 1;
						break;
						case C_IR_KEY_QIBEI:
							gubv_KeyShortQiBei = 1;
						break;
						case C_IR_KEY_LEFI_FANSHEN:
							gubv_KeyShortLeft = 1;
						break;
						case C_IR_KEY_RIGHT_FANSHEN:
							gubv_KeyShortRight = 1;
						break;
						case C_IR_KEY_TAITUI:
							gubv_KeyShortTaiTui = 1;
						break;
						case C_IR_KEY_JIAOTI:
							gubv_KeyShortJiaoTi = 1;
						break;
					}
				}
			}
		}
		gu8v_IrDelay = C_IR_DELAY;
		gu8v_IrRecData[0] = 0x00;	
		gu8v_IrRecData[1] = 0x00;
		gu8v_IrRecData[2] = 0x00;
		gu8v_IrRecData[3] = 0x00;		
	}*/
	if(gubv_IrRecUpdata == 1)
	{
		gubv_IrRecUpdata = 0;
		if(gubv_RfCopyMode)
		{
			if(!gu8v_IrDelay)
			{
				gu8v_433CopyIdData1[0] = gu8v_433RecValue[0];
				gu8v_433CopyIdData1[1] = gu8v_433RecValue[1];
				gu8v_433CopyIdData1[2] = gu8v_433RecValue[2];
			}
			else
			{
				if((gu8v_433CopyIdData1[0]==gu8v_433RecValue[0])&&(gu8v_433CopyIdData1[1]==gu8v_433RecValue[1])&&(gu8v_433CopyIdData1[2]==gu8v_433RecValue[2]))
				{
					reWriteEe:
					gu8v_IdLowByte = gu8v_433RecValue[0];
					gu8v_IdHighByte = gu8v_433RecValue[1];
					writer_eeprom(0x10,gu8v_IdLowByte);
					writer_eeprom(0x11,gu8v_IdHighByte);
					if((gu8v_IdLowByte!=read_eeprom(0x10))||(gu8v_IdHighByte!=read_eeprom(0x11)))
					{
						goto reWriteEe;
					}
					gubv_RfCopyMode = 0;
					Beep(C_BP_NORMAL);
					gu8v_433CopyIdData1[0] = 0;
					gu8v_433CopyIdData1[1] = 0;
					gu8v_433CopyIdData1[2] = 0;
				}
			}
			gu8v_IrDelay = C_IR_DELAY;
		}
		else
		{
			if(!gu8v_IrDelay)
			{
				if((gu8v_433RecValue[0]==gu8v_IdLowByte)&&(gu8v_433RecValue[1]==gu8v_IdHighByte)) //
				{	
					switch(gu8v_433RecValue[2])
					{
						case C_IR_KEY_DEC:
							gubv_KeyShortPreDec = 1;
						break;
						case C_IR_KEY_INC:
							gubv_KeyShortPreAdd = 1;
						break;
						case C_IR_KEY_ALERM_OFF:
							gubv_IrKeyShortAlermOff = 1;
						break;
						case C_IR_KEY_STATIC:
							gubv_KeyShortStatic = 1;
						break;
						case C_IR_KEY_AUTO:
							gubv_KeyShortAuto = 1;
						break;
						case C_IR_KEY_QIBEI:
							gubv_KeyShortQiBei = 1;
						break;
						case C_IR_KEY_LEFI_FANSHEN:
							gubv_KeyShortLeft = 1;
						break;
						case C_IR_KEY_RIGHT_FANSHEN:
							gubv_KeyShortRight = 1;
						break;
						case C_IR_KEY_TAITUI:
							gubv_KeyShortTaiTui = 1;
						break;
						case C_IR_KEY_JIAOTI:
							gubv_KeyShortJiaoTi = 1;
						break;
						case C_IR_KEY_POWER:
							gubv_KeyShortPower = 1;
						break;
					}
					gu8v_IrDelay = C_IR_DELAY;
				}
			}
		}
		gu8v_433RecValue[0] = 0x00;	
		gu8v_433RecValue[1] = 0x00;
		gu8v_433RecValue[2] = 0x00;
		
	}
}
void	Fun_PowerOnMode(void)	
{
	
}
void	Fun_WorkOffMode(void)
{
	if(_lvdo)
	{
		gu8v_LvdDebounce++;
		if(gu8v_LvdDebounce>=100)
		{
			gu8v_LvdDebounce = 0;
			if(!F_LowVoltage)
			{
				F_LowVoltage = 1;
				goto BpErrorOff;
			}
		}
	}
	else
	{
		gu8v_LvdDebounce = 0;
	}
	if(gubv_KeyShortAlermOff||gubv_IrKeyShortAlermOff)
	{
		BpErrorOff:
		if(gu8v_BeepType==C_BP_ERROR)
		{
			gu8v_BeepTime = 0;
			gubv_BeepOn = 0;
			gu8v_BeepCnt = 0;
			gu8v_BeepType = 0;
			Beep(C_BP_NORMAL);
		}
	}
	if(gubv_KeyShortPower)
	{
		gubv_PowerStatus = 0;
		Sys_Init();
		Work_StatusRegInit();
		Beep(C_BP_NORMAL);
		gu8v_WorkMode = C_WORK_ON_MODE;
	}
	WorkModeFlag.byte = 0x00;
	DcfFlag1.byte = 0x00;
}

void	Fun_EnterJiaotiMode(void)
{
	if(!WorkModeFlag.byte)
	{
		gu16v_JiaoTiTimeCnt = 0;
		gubv_DcfA = 1;
		gubv_DcfB = 0;
		gubv_JiaoTiA = 1;
	}
}

void Fun_KeyPressedProcess(void)
{
	if(gubv_KeyShortPreAdd&&!gubv_StaticMode)
	{
		Beep(C_BP_NORMAL);
		if(gu8v_PressureMode<5)	gu8v_PressureMode++;
	}
	if(gubv_KeyShortPreDec&&!gubv_StaticMode)
	{
		Beep(C_BP_NORMAL);
		if(gu8v_PressureMode)	gu8v_PressureMode--;
	}
	if(gubv_KeyShortStatic)
	{
		gubv_StaticMode = ~gubv_StaticMode;
		/*if(gubv_StaticMode)
		{
			gu8v_PressureModeCopy = gu8v_PressureMode;
		}
		else
		{
			gu8v_PressureMode  = gu8v_PressureModeCopy;
		}*/
		WorkModeFlag.byte &= 0x02;
		Fun_EnterJiaotiMode();
		Beep(C_BP_NORMAL);
	}	
	if(gubv_KeyShortAuto)
	{
		gubv_AutoMode = ~gubv_AutoMode;
		if(gubv_AutoMode)
		{
			gubv_AutoLeftFanShenMode = 1;
		}
		else
		{
			gubv_AutoLeftFanShenMode = 0;
		}
		WorkModeFlag.byte &= 0x04;
		gu16v_AutoModeCycle = 0;
		Fun_EnterJiaotiMode();
		Beep(C_BP_NORMAL);
	}	
	if(gubv_KeyShortQiBei)
	{
		gubv_QiBeiMode =~gubv_QiBeiMode;
		WorkModeFlag.byte &= 0x48;
		Fun_EnterJiaotiMode();
		Beep(C_BP_NORMAL);
	}		
	if(gubv_KeyShortLeft)
	{
		gubv_DcfLeftFanShenMode = ~gubv_DcfLeftFanShenMode;

		WorkModeFlag.byte &= 0x10;
		Fun_EnterJiaotiMode();
		Beep(C_BP_NORMAL);

	}	
	if(gubv_KeyShortRight)
	{
		gubv_DcfRightFanShenMode = ~gubv_DcfRightFanShenMode;
		WorkModeFlag.byte &= 0x20;
		Fun_EnterJiaotiMode();
		Beep(C_BP_NORMAL);
	}		
	if(gubv_KeyShortTaiTui)
	{
		gubv_TaituiMode = ~gubv_TaituiMode;
		WorkModeFlag.byte &= 0x48;
		Fun_EnterJiaotiMode();
		Beep(C_BP_NORMAL);

	}	
	if((gubv_KeyShortJiaoTi)&&(!WorkModeFlag.byte))
	{
		Beep(C_BP_NORMAL);
		gu8v_JiaoTiMode++;
		if(gu8v_JiaoTiMode>2)		gu8v_JiaoTiMode = 0;
		switch(gu8v_JiaoTiMode)
		{
			case 0:
				gu16v_JiaoTiTime = C_6_M;
			break;
			case 1:
				gu16v_JiaoTiTime = C_9_M;
			break;
			case 2:
				gu16v_JiaoTiTime = C_12_M;
			break;
		}
	}
	if(gubv_KeyShortPower)
	{
		gubv_PowerStatus = 1;
		Beep(C_BP_NORMAL);
		gu8v_WorkMode = C_WORK_OFF_MODE;
	}
	if(gubv_KeyShortAlermOff)
	{
		gu8v_RfIdCopyKeyCnt++;
		if(!gu8v_RfIdCopyTime)
		{
			gu8v_RfIdCopyTime = 50;
		}
		else
		{
			if(gu8v_RfIdCopyKeyCnt>=5)
			{
				if(!gubv_RfCopyMode)
				{
					gubv_RfCopyMode = 1;
					Beep(C_BP_NORMAL);
				}
				gu8v_RfIdCopyKeyCnt = 0;
			}
		}
	}
}
void	Fun_JiaoTiModeProcess(void)
{
	if(gu16v_PowerOnDelay20)
	{
		gubv_DcfA = 1;
		gubv_DcfB = 1;
		if(gu16v_PowerOnDelay20)
		{
			gu16v_PowerOnDelay20--;
			if(!gu16v_PowerOnDelay20)
			{
				gu16v_JiaoTiTimeCnt = 0;
				if(!WorkModeFlag.byte)
				{
					gubv_DcfB = 0;
					gubv_JiaoTiA = 1;
				}
			}	
		}
	}
	else
	{
		if(WorkModeFlag.byte)
		{
			gu16v_JiaoTiTimeCnt = 0;
			gubv_DcfA = 1;
			gubv_DcfB = 1;
		}
		else
		{
			gu16v_JiaoTiTimeCnt++;
			if(gu16v_JiaoTiTimeCnt>=gu16v_JiaoTiTime)
			{
				gu16v_JiaoTiTimeCnt = 0;
				if(gubv_JiaoTiA)
				{
					gubv_DcfA =~gubv_DcfA;
				}
				else
				{
					gubv_DcfB =~gubv_DcfB;
				}
				gubv_JiaoTiA = ~gubv_JiaoTiA;
			}
			if(gu16v_JiaoTiTimeCnt==(gu16v_JiaoTiTime-C_1_M))
			{
				if(gubv_JiaoTiA)
				{
					if(!gubv_DcfB) 			gubv_DcfB = 1;
				}
				else
				{
					if(!gubv_DcfA) 			gubv_DcfA = 1;
				}
			}
		}
	}
}
void	Fun_WorkOnMode(void)
{
	Fun_KeyPressedProcess();
	if(gubv_1S)
	{
		gubv_1S = 0;
		if(gubv_AutoMode)
		{
			gu16v_AutoModeCycle++;
			if(gu16v_AutoModeCycle>=C_AutoModeCycle)
			{
				gu16v_AutoModeCycle = 0;
			}
			if(gu16v_AutoModeCycle<C_AutoModeZuoON)
			{
				gubv_AutoLeftFanShenMode = 1;
			}
			else if(gu16v_AutoModeCycle<C_AutoModeZuoOFF)
			{
				gubv_AutoLeftFanShenMode = 0;
			}
			else if(gu16v_AutoModeCycle<C_AutoModeYouON)
			{
		
				gubv_AutoRightFanShenMode = 1;
			}
			else
			{
				gubv_AutoRightFanShenMode = 0;
			}
		}
		Fun_JiaoTiModeProcess();
	}
	if(!gubv_AutoMode)
	{
		gubv_AutoLeftFanShenMode = 0;
		gubv_AutoRightFanShenMode = 0;
	}
	if(gubv_StaticMode)
	{

	}
	if(gubv_QiBeiMode)
	{
		gubv_DcfQiBei = 1;
	}
	else
	{
		gubv_DcfQiBei = 0;
	}
	if(gubv_DcfLeftFanShenMode||gubv_AutoLeftFanShenMode)
	{
		gubv_DcfLeftFanShen = 1;
	}
	else
	{
		gubv_DcfLeftFanShen = 0;
	}
	if(gubv_DcfRightFanShenMode||gubv_AutoRightFanShenMode)
	{
		gubv_DcfRightFanShen = 1;
	}
	else
	{
		gubv_DcfRightFanShen = 0;
	}
	if(gubv_TaituiMode)
	{
		gubv_DcfTaiTui = 1;
	}
	else
	{
		gubv_DcfTaiTui = 0;
	}
	
}
void	Fun_PublicProcess(void)
{
	
	KeyFlag1.byte = 0x00;
	KeyFlag2.byte = 0x00;
	
	//if(gubv_DcfA)						P_DCF_A = C_DCF_ON;
	//else								P_DCF_A = C_DCF_OFF;
	if(gubv_DcfB)						P_DCF_B = C_DCF_ON;
	else								P_DCF_B = C_DCF_OFF;
	if(!gu16v_PowerOnDelay20)
	{
		if(gubv_DcfQiBei)				P_DCF_QiBei = C_DCF_ON;
		else							P_DCF_QiBei = C_DCF_OFF;
		if(gubv_DcfRightFanShen)		P_DCF_RightFanShen = C_DCF_ON;
		else							P_DCF_RightFanShen = C_DCF_OFF;
		if(gubv_DcfLeftFanShen)			P_DCF_LeftFanShen = C_DCF_ON;
		else							P_DCF_LeftFanShen = C_DCF_OFF;
		if(gubv_DcfTaiTui)				P_DCF_TaiTui = C_DCF_ON;
		else							P_DCF_TaiTui = C_DCF_OFF;
	}
	else
	{
		P_DCF_QiBei = C_DCF_OFF;
		P_DCF_RightFanShen = C_DCF_OFF;
		P_DCF_LeftFanShen = C_DCF_OFF;
		P_DCF_TaiTui = C_DCF_OFF;
	}
	
	if(gubv_Error)
	{
		gubv_Error = 0;
		Beep(C_BP_ERROR);
	}
	
}
void	Ac_lostDel(void)
{
	if(gu8v_AcOffDebounce)
	{
		gu8v_AcOffDebounce--;
	}
	if(!gu8v_AcOffDebounce)
	{
		if(gubv_12vOff&&(!gubv_PowerButtonOff))
		{
			if(!gubv_ErrorLock)
			{
				gubv_ErrorLock = 1;
				gubv_Error = 1;
			}
		}
	}
}
////===============================================================
////void Function_Task (void)
////===============================================================		
void Function_Task (void)
{
	Fun_IrRecKeyProcess();
	switch(gu8v_WorkMode)
	{
		case C_POWER_ON_MODE:
			//Fun_PowerOnMode();	
		break;	
		case C_WORK_OFF_MODE:
			Fun_WorkOffMode();
		break;
		case C_WORK_ON_MODE:
			Fun_WorkOnMode();
		break;	
	}
	Fun_PublicProcess();
}


